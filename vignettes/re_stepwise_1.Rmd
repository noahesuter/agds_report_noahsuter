---
title: "re_stepwise_1"
author: "Noah Suter"
date: "`r Sys.Date()`"
output: html_document
---
# AGDS Report

## Report Exercise 4

### Preparing the data


```{r results='hide'}
list.files('../data') #listing the files to find the right data
```

```{r results='hide', message=FALSE}
half_hourly_fluxes <- readr::read_csv("../data/df_for_stepwise_regression.csv") # reading the data into R
```

```{r}
visdat::vis_miss(half_hourly_fluxes) #checking for missing values
```

We can see that some columns do have a lot of missing values. It will be important to keep that in mind for the interpretation of the results and for the creation of the model


```{r results='hide'}
summary(half_hourly_fluxes) #looking at the exact number of missing values (NA) per row
```

## Stepwsise forward regression - bivariate models in a loop

```{r}

```


##Full stepwise forward regression with a loop
```{r}
half_hourly_fluxes_new_order <- dplyr::select(half_hourly_fluxes,`GPP_NT_VUT_REF`, everything()) #moving the column of the response variable (GPP) to position one
```

```{r}
half_hourly_fluxes_clean <- stats::na.omit(half_hourly_fluxes_new_order)
```


```{r}
# Define the response variable
response_var <- "GPP_NT_VUT_REF"
# Initialize a vector to store the selected predictors
selected_predictors <- c()
# Initialize a list to store the intermediate models
models <- list()
# Loop through the predictors
for (i in 1:ncol(half_hourly_fluxes_clean)) {
  
  # Initialize a variable to store the best predictor
  best_predictor <- NULL
  
  # Initialize a variable to store the lowest AIC
  lowest_aic <- Inf
  
  # Loop through the remaining predictors
  for (j in setdiff(names(half_hourly_fluxes_clean)[-1], selected_predictors)) {
    
    # Create a formula object for the current predictor
    candidate_formula <- as.formula(paste(response_var, "~", paste(c(selected_predictors, j), collapse = "+")))
    
    # Fit a linear model with the current predictor added
    candidate_lm <- lm(candidate_formula, data = half_hourly_fluxes_op1)
    
    # Check if the AIC is lower than the current lowest AIC
    if (AIC(candidate_lm) < lowest_aic) {
      best_predictor <- j
      lowest_aic <- AIC(candidate_lm)
    }
    
    # Store the intermediate model
    models[[paste(c(selected_predictors, j), collapse = "+")]] <- candidate_lm
  }
  
  # Add the best predictor to the selected predictors
  selected_predictors <- c(selected_predictors, best_predictor)
  
  
}
# Initialize a data frame to store the model statistics
model_stats <- data.frame(Model = character(),
                           AIC = numeric(),
                           Adj_R2 = numeric(),
                           R2 = numeric(),
                           stringsAsFactors = FALSE)
# Loop through the intermediate models and extract the statistics
for (i in seq_along(models)) {
  
  # Extract the model formula and AIC
  model_formula <- formula(models[[i]])
  model_aic <- AIC(models[[i]])
  
  # Extract the model summary and extract the R-squared and adjusted R-squared
  model_summary <- summary(models[[i]])
  model_adj_r2 <- summary(models[[i]])$adj.r.squared
  model_r2 <- summary(models[[i]])$r.squared
  
  # Add the model statistics to the data frame
  model_stats <- rbind(model_stats, data.frame(Model = as.character(model_formula),
                                               AIC = model_aic,
                                               Adj_R2 = model_adj_r2,
                                               R2 = model_r2,
                                               stringsAsFactors = FALSE))
}
```


```{r}
library(dplyr)
library(base)

# Example dataframe

# Group by Formula and summarize by concatenating the values
dataframe_model_values <- model_stats %>%
  group_by(Model) %>%
  summarize(Predictors = paste(Model, collapse = " "),
            AIC = first(AIC),
            Adj_R2= first(Adj_R2),
            R2 = first(R2))
dataframe_model_values[1] <- NULL
```

```{r}
# Sort the model statistics data frame by ascending AIC values
dataframe_model_values <- dataframe_model_values[order(dataframe_model_values$AIC), ]
# Print the top row of the model statistics data frame
cat("Best model based on AIC:\n")
print(dataframe_model_values[1, ])
```

```{r}
print(model_stats[1,])
```
## Full stepwise regression with the function step


